<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Oakdale After-School</title>

  <!-- Bootstrap (optional) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer"
  />

  <link rel="stylesheet" href="app.css">
  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
  <div id="app" class="container py-4">
    <!-- Login -->
    <div v-if="!loggedIn" class="text-center mt-5">
      <h1>Oakdale After-School</h1>
      <p>Log in as Student or Parent</p>
      <div class="mx-auto" style="max-width:360px;">
        <input class="form-control mb-2" v-model="username" placeholder="Your name" />
        <select class="form-select mb-2" v-model="role">
          <option value="" disabled>Select role</option>
          <option>Student</option>
          <option>Parent</option>
        </select>
        <button class="btn btn-primary w-100" @click="login">Login</button>
      </div>
    </div>

    <!-- Main -->
    <div v-else>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h4>Welcome, {{ username }} ({{ role }})</h4>
        </div>
        <div class="d-flex align-items-center gap-2">
          <input class="form-control me-2" style="min-width:260px;"
                 v-model="searchText"
                 @input="onSearchInput"
                 placeholder="Search lessons (search-as-you-type)">
          <select class="form-select" style="width:200px;" v-model="sortBy" @change="applySort">
            <option value="">Sort by...</option>
            <option value="subject">Subject</option>
            <option value="location">Location</option>
            <option value="price">Price</option>
            <option value="availableSpace">Spaces</option>
          </select>
          <select class="form-select" style="width:120px;" v-model="sortDir" @change="applySort">
            <option value="asc">Asc</option>
            <option value="desc">Desc</option>
          </select>

          <!-- cart toggle -->
          <button class="btn btn-outline-success ms-2" :disabled="cart.length===0" @click="toggleCart">
            <i class="fa-solid fa-cart-shopping"></i> Cart ({{ cart.length }})
          </button>

          <button class="btn btn-secondary ms-2" @click="logout">Logout</button>
        </div>
      </div>

      <!-- Lessons page -->
      <div v-if="!showingCart">
        <h5>Available lessons ({{ lessons.length }})</h5>
        <div class="row gy-3">
          <div class="col-md-6 col-lg-4" v-for="lesson in displayedLessons" :key="lesson._id">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">
                  <i :class="['fa-solid', lesson.icon]" style="margin-right:8px"></i>
                  {{ lesson.subject }}
                </h5>
                <p class="card-text mb-1"><strong>Location:</strong> {{ lesson.location }}</p>
                <p class="card-text mb-1"><strong>Price:</strong> £{{ lesson.price }}</p>
                <p class="card-text mb-1"><strong>Spaces:</strong> {{ lesson.availableSpace }}</p>
                <div class="d-flex gap-2 mt-2">
                  <button class="btn btn-sm btn-primary" 
                          :disabled="lesson.availableSpace<=0"
                          @click="addToCart(lesson)">
                    <i class="fa-solid fa-plus"></i> Add to cart
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" @click="viewLesson(lesson)">Details</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cart / Checkout page -->
      <div v-else>
        <h5>Shopping Cart</h5>
        <div v-if="cart.length===0" class="alert alert-info">No items in cart.</div>
        <ul class="list-group mb-3">
          <li class="list-group-item d-flex justify-content-between align-items-center" v-for="(c, idx) in cart" :key="idx">
            <div>
              <i :class="['fa-solid', c.icon]" style="margin-right:8px"></i> {{ c.subject }}
              <div class="text-muted small">Location: {{ c.location }}</div>
            </div>
            <div>
              £{{ c.price }}
              <button class="btn btn-sm btn-danger ms-2" @click="removeFromCart(idx)">Remove</button>
            </div>
          </li>
        </ul>

        <p><strong>Total:</strong> £{{ cartTotal }}</p>

        <div class="card p-3">
          <h6>Checkout</h6>
          <input class="form-control mb-2" placeholder="Full name (letters only)" v-model="checkoutName">
          <input class="form-control mb-2" placeholder="Phone (digits only)" v-model="checkoutPhone">
          <div class="d-flex gap-2">
            <button class="btn btn-success" :disabled="!canCheckout" @click="submitOrder">Submit Order</button>
            <button class="btn btn-outline-secondary" @click="toggleCart">Back to lessons</button>
          </div>
          <div v-if="orderMessage" class="mt-2 alert alert-success">{{ orderMessage }}</div>
        </div>
      </div>

    </div>
  </div>

  <script>
  
  const { createApp } = Vue;

createApp({
  data() {
    return {
      loggedIn: false,
      username: '',
      role: '',
      lessons: [],       // loaded from backend
      searchText: '',
      sortBy: '',
      sortDir: 'asc',
      cart: [],
      showingCart: false,
      checkoutName: '',
      checkoutPhone: '',
      orderMessage: '',
      searchTimer: null,
      apiBase: 'https://cw-back-end.onrender.com/api' // if you host API on another domain, replace with full URL like 'https://your-api.onrender.com/api'
    };
  },

  computed: {
    displayedLessons() {
      let arr = [...this.lessons];
      if (this.sortBy) {
        arr.sort((a,b) => {
          let av = a[this.sortBy], bv = b[this.sortBy];
          if (typeof av === 'string') av = av.toLowerCase();
          if (typeof bv === 'string') bv = bv.toLowerCase();
          if (av < bv) return this.sortDir==='asc' ? -1 : 1;
          if (av > bv) return this.sortDir==='asc' ? 1 : -1;
          return 0;
        });
      }
      return arr;
    },

    cartTotal() {
      return this.cart.reduce((s, it) => s + Number(it.price), 0);
    },

    canCheckout() {
      const nameOK = /^[A-Za-z\s]+$/.test(this.checkoutName);
      const phoneOK = /^\d+$/.test(this.checkoutPhone);
      return this.cart.length>0 && nameOK && phoneOK;
    }
  },

  methods: {
    login() {
      if (!this.username || !this.role) { alert('Enter name and role'); return; }
      this.loggedIn = true;
      this.fetchLessons();
    },

    logout() {
      this.loggedIn = false;
      this.username = '';
      this.role = '';
      this.cart = [];
      this.lessons = [];
    },

    fetchLessons() {
      fetch(`${this.apiBase}/lessons`)
        .then(r => r.json())
        .then(data => { this.lessons = data; })
        .catch(err => console.error('fetch lessons error', err));
    },

    onSearchInput() {
      clearTimeout(this.searchTimer);
      this.searchTimer = setTimeout(() => {
        this.performSearch();
      }, 300);
    },

    performSearch() {
      if (!this.searchText.trim()) {
        this.fetchLessons();
        return;
      }
      const q = encodeURIComponent(this.searchText);
      fetch(`${this.apiBase}/search?q=${q}`)
        .then(r => r.json())
        .then(data => { this.lessons = data; })
        .catch(err => console.error('search error', err));
    },

    applySort() { /* computed handles it */ },

    addToCart(lesson) {
      if (lesson.availableSpace <= 0) return;
      const copy = { ...lesson };
      this.cart.push(copy);
      const idx = this.lessons.findIndex(l => l._id === lesson._id);
      if (idx >= 0) { this.lessons[idx].availableSpace -= 1; }
    },

    removeFromCart(index) {
      const item = this.cart[index];
      const idx = this.lessons.findIndex(l => l._id === item._id);
      if (idx >= 0) { this.lessons[idx].availableSpace += 1; }
      this.cart.splice(index, 1);
    },

    toggleCart() {
      this.orderMessage = '';
      this.showingCart = !this.showingCart;
    },

    viewLesson(lesson) {
      alert(`${lesson.subject}\nLocation: ${lesson.location}\nPrice: £${lesson.price}\nSpaces: ${lesson.availableSpace}`);
    },

    submitOrder() {
      if (!this.canCheckout) return;
      const counts = {};
      this.cart.forEach(c => { counts[c._id] = (counts[c._id] || 0) + 1; });

      const order = {
        name: this.checkoutName,
        phone: this.checkoutPhone,
        lessons: Object.keys(counts).map(id => ({ lessonId: id, qty: counts[id] })),
        createdAt: new Date().toISOString()
      };

      fetch(`${this.apiBase}/orders`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(order)
      })
      .then(r => { if(!r.ok) throw new Error('Order failed'); return r.json(); })
      .then(saved => {
        const updates = order.lessons.map(l => {
          return fetch(`${this.apiBase}/lessons/${l.lessonId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ $incSpaces: -l.qty })
          }).then(r=>r.json());
        });
        return Promise.all(updates).then(() => saved);
      })
      .then(saved => {
        this.orderMessage = 'Order submitted. Order ID: ' + (saved.insertedId || saved._id || saved.id);
        this.cart = [];
        this.checkoutName = '';
        this.checkoutPhone = '';
        this.fetchLessons();
      })
      .catch(err => { console.error(err); alert('Error submitting order'); });
    }}
  }).mount('#app');</script>
  

</body>
</html>
